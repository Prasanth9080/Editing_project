{% extends "base.html" %}
{% load static %}
{% block title %}KYC Submission{% endblock %}

{% block content %}
<style>
    .btn-add-new {
        width: 120px;
    }

    #kycForm {
        display: none;
    }

    .table-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .table th, .table td {
        white-space: nowrap;
        vertical-align: middle;
    }

    .table-img {
        max-width: 100px;
        height: auto;
    }

    .input-group-sm {
        max-width: 300px;
    }

    .modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-content {
  width: 100%;
  max-width: 600px;
}

.d-none {
  display: none !important;
}


    @media (max-width: 576px) {
        .table th, .table td {
            font-size: 13px;
            padding: 6px;
        }

        .btn-sm {
            font-size: 12px;
            padding: 3px 6px;
        }

        .table-img {
            max-width: 70px;
        }

        .input-group-sm {
            width: 100%;
        }

        .btn-add-new {
            width: 100%;
        }
    }
</style>

<div class="container mt-5 mb-5">
    <h2 class="text-center mb-4">Welcome, {{ request.user.username }}</h2>

    <!-- Add New Button -->
<div class="text-start mb-4">
  <button class="btn btn-info text-white btn-add-new" onclick="toggleForm()">Add New</button>
</div>

<!-- Add New Form Popup -->
<div id="kycFormOverlay" class="modal-overlay d-none">
  <div class="modal-content bg-white text-secondary p-4 rounded shadow-lg position-relative">
    <!-- Close Button -->
    <button type="button" class="btn-close btn-close-dark position-absolute top-0 end-0 m-3" onclick="toggleForm()" aria-label="Close"></button>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
      {% endif %}

      <label>Name:</label>
      <input type="text" name="name" class="form-control mb-2" required>

      <label>Mobile Number:</label>
      <input type="text" name="mobile_number" class="form-control mb-2" pattern="\d{10}" maxlength="10" required>

      <label>Aadhar Number:</label>
      <input type="text" name="aadhar_number" class="form-control mb-2" maxlength="14" pattern="\d{4}\s\d{4}\s\d{4}" title="Enter 12 digits in 4-4-4 format" required>

      <label>Aadhar Image:</label>
      <input type="file" name="aadhar_image" accept="image/*" class="form-control mb-2" required>

      <label>PAN Number:</label>
      <input type="text" name="pan_number" class="form-control mb-2" required>

      <label>PAN Image:</label>
      <input type="file" name="pan_image" accept="image/*" class="form-control mb-2" required>

      <button type="submit" class="btn btn-light bg-success text-white mt-3">Submit</button>
    </form>
  </div>
</div>


    {% if kyc_list %}
    <!-- Container for title and search (responsive) -->
<!-- Responsive Title and Search -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
    <h3 class="mb-2 mb-md-0">Submitted KYC Details</h3>

    <!-- Search Input Group -->
    <div class="input-group input-group-sm d-flex" style="max-width: 300px;">
        <div><input type="text" id="searchInput" class="form-control" placeholder="Search by Mobile Number" aria-label="Search"></div>
        <div><button class="btn btn-outline-secondary ms-1 bg-success text-white" type="button" id="searchBtn">
            <i class="bi bi-search"></i>
        </button></div>
    </div>
</div>


        <div class="table-responsive">
            <table class="table table-bordered table-striped" id="kycTable">
                <thead class="table-dark">
                    <tr>
                        <th>S.No</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Aadhar</th>
                        <th>PAN</th>
                        <th>Aadhar Image</th>
                        <th>PAN Image</th>
                        <th>Date/Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for kyc in kyc_list %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ kyc.name }}</td>
                        <td class="mobile-col">{{ kyc.mobile_number }}</td>
                        <td>{{ kyc.aadhar_number }}</td>
                        <td>{{ kyc.pan_number }}</td>
                        <td><img src="{{ kyc.aadhar_image.url }}" class="img-fluid table-img"></td>
                        <td><img src="{{ kyc.pan_image.url }}" class="img-fluid table-img"></td>
                        <td>{{ kyc.created_at }}</td>
                        <td>
                            <a href="{% url 'edit_kyc' kyc.id %}" class="btn btn-warning btn-sm">Edit</a>
                            <a href="{% url 'delete_kyc' kyc.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?')">Delete</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p id="noData" class="text-center text-danger fw-bold" style="display: none;">No data found</p>
        </div>
    {% else %}
    <p>No KYC data found.</p>
    {% endif %}
</div>

<!-- Bootstrap Icons CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<script>
    function toggleForm() {
        const form = document.getElementById('kycForm');
        form.style.display = (form.style.display === 'none') ? 'block' : 'none';
    }

    const token = '{{ request.session.access_token|default_if_none:"" }}';
    if (token) {
        localStorage.setItem("auth_token", token);
    }

    document.getElementById("searchBtn").addEventListener("click", function () {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll("#kycTable tbody tr");
        let found = false;

        rows.forEach(row => {
            const mobile = row.querySelector(".mobile-col").textContent.toLowerCase();
            if (mobile.includes(input)) {
                row.style.display = "";
                found = true;
            } else {
                row.style.display = "none";
            }
        });

        document.getElementById("noData").style.display = found ? "none" : "block";
    });

    document.getElementById("searchInput").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("searchBtn").click();
        }
    });
</script>

<script>
function toggleForm() {
  const formOverlay = document.getElementById('kycFormOverlay');
  formOverlay.classList.toggle('d-none');
}
</script>

{% endblock %}
